# çŸ­ä¿¡å®šæ—¶æé†’ç³»ç»Ÿ

ä¸€ä¸ªåŸºäºFlaskçš„æ™ºèƒ½çŸ­ä¿¡å®šæ—¶æé†’ç³»ç»Ÿï¼Œç»“åˆæ™ºèƒ½ä½“å’ŒçŸ­ä¿¡å®APIï¼Œå®ç°è‡ªç„¶è¯­è¨€åˆ›å»ºå®šæ—¶çŸ­ä¿¡æé†’ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- âœ… æ™ºèƒ½ä½“å‹å¥½æ¥å£ï¼šæ”¯æŒè‡ªç„¶è¯­è¨€äº¤äº’
- âœ… è‡ªåŠ¨å‘é€çŸ­ä¿¡ï¼šé›†æˆçŸ­ä¿¡å®APIï¼Œåˆ°æ—¶è‡ªåŠ¨å‘é€
- âœ… çµæ´»æ—¶é—´è®¾ç½®ï¼šæ”¯æŒå•æ¬¡å’Œå¾ªç¯æé†’
- âœ… å¤šç§å¾ªç¯æ¨¡å¼ï¼šæ¯å¤©ã€æ¯å‘¨Xã€æ¯å°æ—¶ã€æ¯æœˆ
- âœ… ä»»åŠ¡ç®¡ç†ï¼šåˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤æé†’ä»»åŠ¡
- âœ… ç¨³å®šå¯é ï¼šSQLiteæ•°æ®åº“å­˜å‚¨ï¼Œåå°å®šæ—¶æ£€æŸ¥

## ğŸ”§ å®‰è£…éƒ¨ç½²

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.7+
- Flask
- APScheduler
- requests
- SQLAlchemy

### 2. å®‰è£…ä¾èµ–

```bash
pip install flask flask-sqlalchemy apscheduler requests
```

æˆ–è€…ä½¿ç”¨requirements.txtï¼š

```bash
pip install -r requirements.txt
```

### 3. é…ç½®çŸ­ä¿¡å®è´¦å·

ç¼–è¾‘ `SMS_webhook.py` æ–‡ä»¶ï¼Œä¿®æ”¹çŸ­ä¿¡å®é…ç½®ï¼š

```python
# çŸ­ä¿¡å®é…ç½®
SMSBAO_USERNAME = "YOUR_USERNAME"          # çŸ­ä¿¡å®ç”¨æˆ·å
SMSBAO_PASSWORD = "YOUR_PASSWORD_MD5"      # å¯†ç MD5æˆ–ApiKey
SMSBAO_GOODSID = ""                        # äº§å“IDï¼ˆå¯é€‰ï¼‰
SMSBAO_API_URL = "http://api.smsbao.com/sms"
```

> ğŸ’¡ æ¨èä½¿ç”¨ ApiKey è€Œä¸æ˜¯å¯†ç MD5ï¼Œæ›´å®‰å…¨ï¼

### 4. å¯åŠ¨ç¨‹åº

```bash
python SMS_webhook.py
```

ç¨‹åºå°†åœ¨ `http://0.0.0.0:5000` å¯åŠ¨

## ğŸ“¡ APIæ¥å£è¯´æ˜

### 1. æ™ºèƒ½ä½“ç®€åŒ–æ¥å£ï¼ˆæ¨èï¼‰

**æ¥å£**: `GET/POST /`

è¿™æ˜¯ä¸ºæ™ºèƒ½ä½“ä¼˜åŒ–çš„ç®€åŒ–æ¥å£ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€å‚æ•°ã€‚

**è¯·æ±‚å‚æ•°**:

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| uuid | String | æ˜¯ | ä»»åŠ¡å”¯ä¸€æ ‡è¯† | `task_20251109_001` |
| content | String | æ˜¯ | çŸ­ä¿¡å†…å®¹ | `çº å¯Ÿå¤§é˜Ÿè¦å¼€ä¼š` |
| phone | String | æ˜¯ | æ‰‹æœºå· | `18259937559` |
| time | String | æ˜¯ | æé†’æ—¶é—´ï¼ˆHH:MMæ ¼å¼ï¼‰ | `21:10` |
| repeat | String | å¦ | é‡å¤è§„åˆ™ | `æ¯å‘¨æ—¥` / `æ¯å¤©` / `æ¯å°æ—¶` |

**è¯·æ±‚ç¤ºä¾‹**:

```
GET /?uuid=task_20251109_001&content=çº å¯Ÿå¤§é˜Ÿè¦å¼€ä¼š&phone=18259937559&time=21:10&repeat=æ¯å‘¨æ—¥
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æé†’ä»»åŠ¡åˆ›å»ºæˆåŠŸ",
  "uuid": "task_20251109_001",
  "scheduled_time": "2025-11-10T21:10:00",
  "is_circulation": true,
  "circulation_interval": 10080,
  "next_trigger": "2025-11-10 21:10:00"
}
```

**æ”¯æŒçš„é‡å¤è§„åˆ™**:

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| `æ¯å¤©` | æ¯å¤©é‡å¤ |
| `æ¯å‘¨æ—¥` / `æ¯å‘¨ä¸€` ... `æ¯å‘¨å…­` | æ¯å‘¨æŒ‡å®šæ—¥æœŸé‡å¤ |
| `æ¯å°æ—¶` | æ¯å°æ—¶é‡å¤ |
| `æ¯æœˆ` | æ¯æœˆé‡å¤ |
| ä¸æä¾›repeatå‚æ•° | å•æ¬¡æé†’ |

---

### 2. æ ‡å‡†JSONæ¥å£

**æ¥å£**: `POST /api/sms/create`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| uuid | String | æ˜¯ | ä»»åŠ¡å”¯ä¸€æ ‡è¯† |
| sms_content | String | æ˜¯ | çŸ­ä¿¡å†…å®¹ |
| target_number | String | æ˜¯ | ç›®æ ‡æ‰‹æœºå· |
| time | String | æ˜¯ | å‘é€æ—¶é—´ï¼ˆISOæ ¼å¼æˆ– `YYYY-MM-DD HH:MM:SS`ï¼‰|
| is_circulation | Boolean | å¦ | æ˜¯å¦å¾ªç¯ï¼ˆé»˜è®¤falseï¼‰ |
| circulation_interval | Integer | å¦ | å¾ªç¯é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "uuid": "task_20251109_001",
  "sms_content": "è¿™æ˜¯ä¸€æ¡æé†’çŸ­ä¿¡",
  "target_number": "13800138000",
  "time": "2025-11-06 15:30:00",
  "is_circulation": true,
  "circulation_interval": 1440
}
```

---

### 3. æŸ¥è¯¢æé†’ä»»åŠ¡

**æ¥å£**: `GET /api/sms/list/<uuid>`

**è¯·æ±‚ç¤ºä¾‹**:
```
GET /api/sms/list/task_20251109_001
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "uuid": "task_20251109_001",
    "sms_content": "çº å¯Ÿå¤§é˜Ÿè¦å¼€ä¼š",
    "target_number": "18259937559",
    "time": "2025-11-10T21:10:00",
    "is_circulation": true,
    "circulation_interval": 10080,
    "is_sent": false,
    "last_sent_time": null
  }
}
```

---

### 4. åˆ é™¤æé†’ä»»åŠ¡

**æ¥å£**: `DELETE /api/sms/delete/<uuid>`

**è¯·æ±‚ç¤ºä¾‹**:
```
DELETE /api/sms/delete/task_20251109_001
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æé†’ä»»åŠ¡åˆ é™¤æˆåŠŸ"
}
```

---

### 5. å¥åº·æ£€æŸ¥

**æ¥å£**: `GET /health`

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "timestamp": "2025-11-09T14:30:00"
}
```

## ğŸ“Š æ•°æ®åº“ç»“æ„

ä½¿ç”¨SQLiteæ•°æ®åº“ï¼Œè¡¨åä¸º `sms_reminders`ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | Integer | ä¸»é”® |
| uuid | String | ä»»åŠ¡å”¯ä¸€æ ‡è¯† |
| bstudio_create_time | DateTime | åˆ›å»ºæ—¶é—´ |
| sms_content | String | çŸ­ä¿¡å†…å®¹ |
| target_number | String | ç›®æ ‡æ‰‹æœºå· |
| time | DateTime | å‘é€æ—¶é—´ |
| is_circulation | Boolean | æ˜¯å¦å¾ªç¯ |
| circulation_interval | Integer | å¾ªç¯é—´éš”ï¼ˆåˆ†é’Ÿï¼‰|
| is_sent | Boolean | æ˜¯å¦å·²å‘é€ |
| last_sent_time | DateTime | æœ€åå‘é€æ—¶é—´ |

## ğŸ”„ å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ™ºèƒ½ä½“     â”‚ ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€åˆ›å»ºæé†’
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flask API  â”‚ æ¥æ”¶è¯·æ±‚ï¼Œè§£æå‚æ•°ï¼Œåˆ›å»ºä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“     â”‚ å­˜å‚¨æé†’ä»»åŠ¡ä¿¡æ¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®šæ—¶è°ƒåº¦å™¨   â”‚ æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡å¾…å‘é€ä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çŸ­ä¿¡å®API  â”‚ è‡ªåŠ¨å‘é€çŸ­ä¿¡ï¼ˆç¨€é¥­ç§‘æŠ€ç­¾åï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ¯å‘¨æ—¥æé†’

**ç”¨æˆ·å¯¹æ™ºèƒ½ä½“è¯´**ï¼š
> "æ¯å‘¨æ—¥æ™šä¸Š9ç‚¹10åˆ†æé†’æˆ‘çº å¯Ÿå¤§é˜Ÿè¦å¼€ä¼šï¼Œæ‰‹æœºå·18259937559"

**æ™ºèƒ½ä½“è°ƒç”¨**ï¼š
```
http://118.196.48.154:5000/?uuid=task_20251109_211030&content=çº å¯Ÿå¤§é˜Ÿè¦å¼€ä¼š&phone=18259937559&time=21:10&repeat=æ¯å‘¨æ—¥
```

**ç»“æœ**ï¼š
- ç³»ç»Ÿåˆ›å»ºä»»åŠ¡
- æ¯å‘¨æ—¥21:10è‡ªåŠ¨å‘é€çŸ­ä¿¡
- çŸ­ä¿¡å†…å®¹ï¼š`ã€ç¨€é¥­ç§‘æŠ€ã€‘çº å¯Ÿå¤§é˜Ÿè¦å¼€ä¼š`

---

### ç¤ºä¾‹2ï¼šæ¯å¤©å›ºå®šæ—¶é—´

**ç”¨æˆ·å¯¹æ™ºèƒ½ä½“è¯´**ï¼š
> "æ¯å¤©æ—©ä¸Š8ç‚¹æé†’æˆ‘å–æ°´ï¼Œæ‰‹æœºå·13800138000"

**æ™ºèƒ½ä½“è°ƒç”¨**ï¼š
```
http://118.196.48.154:5000/?uuid=task_20251109_211031&content=å–æ°´æé†’&phone=13800138000&time=08:00&repeat=æ¯å¤©
```

**ç»“æœ**ï¼š
- æ¯å¤©æ—©ä¸Š8ç‚¹å‘é€çŸ­ä¿¡
- çŸ­ä¿¡å†…å®¹ï¼š`ã€ç¨€é¥­ç§‘æŠ€ã€‘å–æ°´æé†’`

---

### ç¤ºä¾‹3ï¼šä¸€æ¬¡æ€§æé†’

**ç”¨æˆ·å¯¹æ™ºèƒ½ä½“è¯´**ï¼š
> "æ˜å¤©ä¸‹åˆ3ç‚¹æé†’æˆ‘å¼€ä¼šï¼Œæ‰‹æœºå·13800138000"

**æ™ºèƒ½ä½“è°ƒç”¨**ï¼š
```
http://118.196.48.154:5000/?uuid=task_20251109_211032&content=å¼€ä¼šæé†’&phone=13800138000&time=15:00
```

**ç»“æœ**ï¼š
- æ˜å¤©15:00å‘é€ä¸€æ¬¡çŸ­ä¿¡
- å‘é€åä»»åŠ¡å®Œæˆ

## âš™ï¸ é…ç½®è¯´æ˜

### ä¿®æ”¹æ£€æŸ¥é—´éš”

é»˜è®¤æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚éœ€ä¿®æ”¹ï¼š

```python
scheduler.add_job(
    func=check_and_send_reminders,
    trigger='interval',
    seconds=30,  # ä¿®æ”¹è¿™é‡Œ
    ...
)
```

### ä¿®æ”¹çŸ­ä¿¡ç­¾å

```python
def send_sms(uuid, sms_content, target_number):
    # æ·»åŠ ç­¾å
    if not sms_content.startswith('ã€'):
        sms_content = f"ã€ç¨€é¥­ç§‘æŠ€ã€‘{sms_content}"  # ä¿®æ”¹ç­¾å
```

### ä¿®æ”¹ç›‘å¬ç«¯å£

```python
app.run(host='0.0.0.0', port=5000, debug=False)  # ä¿®æ”¹portå‚æ•°
```

## ğŸ“ æ—¥å¿—è¯´æ˜

ç¨‹åºä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```
2025-11-09 21:10:00 - INFO - æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
2025-11-09 21:10:00 - INFO - å®šæ—¶è°ƒåº¦å™¨å¯åŠ¨æˆåŠŸ
2025-11-09 21:10:00 - INFO - å¯åŠ¨SMS Webhookå®šæ—¶æé†’ç¨‹åº...
2025-11-09 21:10:30 - INFO - åˆ›å»ºæ–°æé†’ä»»åŠ¡: UUID=task_20251109_001, æ—¶é—´=2025-11-10 21:10:00
2025-11-10 21:10:00 - INFO - çŸ­ä¿¡å‘é€æˆåŠŸ: UUID=task_20251109_001, æ‰‹æœºå·=18259937559
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **UUIDå”¯ä¸€æ€§**ï¼šæ¯ä¸ªä»»åŠ¡å¿…é¡»ä½¿ç”¨å”¯ä¸€çš„UUIDï¼Œå»ºè®®ä½¿ç”¨æ—¶é—´æˆ³
2. **æ—¶é—´æ ¼å¼**ï¼šæ™ºèƒ½ä½“æ¥å£ä½¿ç”¨HH:MMæ ¼å¼ï¼ˆ24å°æ—¶åˆ¶ï¼‰
3. **çŸ­ä¿¡ç­¾å**ï¼šæ‰€æœ‰çŸ­ä¿¡ä¼šè‡ªåŠ¨æ·»åŠ ã€ç¨€é¥­ç§‘æŠ€ã€‘ç­¾å
4. **ç³»ç»Ÿæ—¶é—´**ï¼šç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®
5. **æ•°æ®åº“å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ `sms_reminders.db` æ–‡ä»¶
6. **ç”Ÿäº§éƒ¨ç½²**ï¼šå»ºè®®ä½¿ç”¨ supervisor æˆ– systemd ç®¡ç†è¿›ç¨‹

## ğŸ”’ çŸ­ä¿¡å®é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| 0 | å‘é€æˆåŠŸ |
| 30 | å¯†ç é”™è¯¯ |
| 40 | è´¦å·ä¸å­˜åœ¨ |
| 41 | ä½™é¢ä¸è¶³ |
| 43 | IPåœ°å€é™åˆ¶ |
| 50 | å†…å®¹å«æœ‰æ•æ„Ÿè¯ |
| 51 | æ‰‹æœºå·ç ä¸æ­£ç¡® |

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### åˆ›å»ºä»»åŠ¡ï¼ˆæ™ºèƒ½ä½“æ¥å£ï¼‰

```bash
curl "http://localhost:5000/?uuid=test001&content=æµ‹è¯•çŸ­ä¿¡&phone=13800138000&time=21:10&repeat=æ¯å¤©"
```

### åˆ›å»ºä»»åŠ¡ï¼ˆæ ‡å‡†æ¥å£ï¼‰

```bash
curl -X POST http://localhost:5000/api/sms/create \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "test002",
    "sms_content": "æµ‹è¯•çŸ­ä¿¡",
    "target_number": "13800138000",
    "time": "2025-11-09 21:10:00"
  }'
```

### æŸ¥è¯¢ä»»åŠ¡

```bash
curl http://localhost:5000/api/sms/list/test001
```

### åˆ é™¤ä»»åŠ¡

```bash
curl -X DELETE http://localhost:5000/api/sms/delete/test001
```

### å¥åº·æ£€æŸ¥

```bash
curl http://localhost:5000/health
```

## ğŸ“¦ ä¾èµ–æ¸…å•

åˆ›å»º `requirements.txt`ï¼š

```
Flask==2.3.3
Flask-SQLAlchemy==3.0.5
APScheduler==3.10.4
requests==2.31.0
```

## ğŸš€ ç”Ÿäº§éƒ¨ç½²å»ºè®®

### ä½¿ç”¨ Supervisor

åˆ›å»º `/etc/supervisor/conf.d/sms_reminder.conf`ï¼š

```ini
[program:sms_reminder]
command=/usr/bin/python3 /path/to/SMS_webhook.py
directory=/path/to/
autostart=true
autorestart=true
user=www-data
stdout_logfile=/var/log/sms_reminder.log
stderr_logfile=/var/log/sms_reminder_error.log
```

å¯åŠ¨ï¼š
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start sms_reminder
```

### ä½¿ç”¨ Systemd

åˆ›å»º `/etc/systemd/system/sms_reminder.service`ï¼š

```ini
[Unit]
Description=SMS Reminder Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/
ExecStart=/usr/bin/python3 /path/to/SMS_webhook.py
Restart=always

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl enable sms_reminder
sudo systemctl start sms_reminder
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›ä¸ªäººä½¿ç”¨ã€‚
